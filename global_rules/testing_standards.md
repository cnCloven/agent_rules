## 1. 目的与适用范围

本文件定义**测试策略与质量基线**，覆盖：

- 单元测试（Unit Test）
- 组件/集成测试（Component / Integration Test）
- 回归测试与自动化
- 覆盖率与性能 / 稳定性指标

AI Agent 在设计代码结构、测试用例、CI 流程时，应默认遵循本规范。

---

## 2. 测试分层策略概览

整体测试金字塔：

1. **单元测试（UT）**  
   - 目标：验证函数/类/小模块的业务逻辑  

2. **组件/集成测试（IT）**  
   - 目标：验证模块间协同、与外部接口/静态库的整体行为  

3. **系统/端到端测试**  
   - 目标：在接近真实环境下验证整体功能  

4. **回归测试（Regression）**  
   - 目标：缺陷修复不引入新问题  

---

## 3. 单元测试（Unit Test）

### 3.1 范围与原则

- 重点覆盖：
  - 业务规则、状态机、核心逻辑；
  - 数据解析 / 映射逻辑；
- 不在单元测试中依赖：
  - 真实硬件/外部设备；
  - 真实 UI/数据库（应 Mock）。

### 3.2 目录与命名建议

```text
test/
   ├─ unit/
   └─ integration/
```

- 单元测试文件命名：`<target>_ut.cpp`，如 `session_manager_ut.cpp`。

### 3.3 测试框架选型（约束）

- 推荐使用**单文件/轻量级测试框架**，如：
  - Catch2 v2.x（MIT License）或 doctest（MIT License）
- 必须符合：
  - 许可证满足项目要求；
  - **可在目标环境构建**；
  - 以源码/头文件方式集成至仓库，不依赖系统全局安装。

### 3.4 编写规范

- 每个测试用例 **MUST** 明确：
  - 输入（Input）；
  - 预期输出 / 状态（Expected）；
  - 关键边界条件（Boundary）。

### 3.5 Mock / Stub 使用

- 对外部接口，单元测试中应通过**接口抽象 + Mock 实现**：
  - 避免将 I/O 和硬件引入单元测试。

---

## 4. 组件与集成测试（Integration Test）

### 4.1 范围

- 测试真实或仿真的模块组合：
  - 模块协同；
  - 与外部静态库的真实交互。

### 4.2 目录与命名

- 放置在 `test/integration/`；
- 文件命名：`<scenario>_it.cpp`。

---

## 5. 回归测试与缺陷验证

### 5.1 回归测试库

- 每个已修复缺陷 **MUST**：
  - 衍生出至少一个自动化测试用例（UT/IT/脚本），可重放问题场景；
  - 将测试用例纳入回归测试集，随 CI 长期执行。

### 5.2 缺陷关闭标准

- 缺陷被标记为“已修复”前，必须满足：
  - 问题可按原始步骤复现；
  - 新测试用例覆盖该缺陷场景，且在已修复版本中通过；
  - 回归测试集在目标分支上全部通过。

---

## 6. 覆盖率指标要求

### 6.1 度量范围

- 建议使用编译器/工具链支持的覆盖率工具（如 gcov/llvm-cov）统计：
  - 行覆盖（Line Coverage）；
  - 分支覆盖（Branch Coverage）。

### 6.2 指标基线（可按项目调整）

- 对关键模块：
  - 行覆盖率 **≥ 70%**；
  - 分支覆盖率 **≥ 60%**；

- 对安全敏感模块：
  - 行覆盖率 **≥ 80%**；

> 注：覆盖率是“底线”指标，不代表质量已达标；更重要的是**关键路径场景是否被系统性测试**。

---

## 7. 性能与稳定性测试

### 7.1 性能指标

具体数值根据项目要求调整，AI Agent 在设计测试时应留有配置能力：

- 关键操作响应时间应**可监控**，在测试报告中记录。

### 7.2 稳定性 / 资源测试

- **长时间运行测试**：
  - 连续运行关键业务；
  - 期间监控内存使用、CPU 占用、句柄数量，确保无持续增长（内存/句柄泄露）。

---

## 8. 测试数据、日志与可追踪性

### 8.1 测试数据管理

- 建议在 `testdata/` 下维护：
  - 录制的数据报文；
  - 配置片段；
  - 模拟用数据文件。

### 8.2 日志要求

- 测试执行时应开启统一日志：
  - 记录输入、输出、时间戳、错误码；
  - 日志内容应足以复现和分析问题。

---

## 9. QA 审核与发布准入标准

### 9.1 QA 基本检查项

在版本进入发布流程前，至少应满足：

- [ ] 单元测试通过，覆盖率达成项目设定基线；
- [ ] 集成测试通过，关键业务场景覆盖；
- [ ] 回归测试全绿，无待解决 P0/P1 缺陷；

### 9.2 AI Agent 使用说明

在涉及以下输出场景时，AI Agent 应内置本规范：

- 设计测试用例/测试计划；
- 生成 UT/IT 示例代码；
- 建议 CI 阶段步骤与 gate 条件；
- 分析 bug 并建议回归测试项。
