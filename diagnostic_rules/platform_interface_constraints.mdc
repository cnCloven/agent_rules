---
description: å¹³å°åŸºç¡€æ¥å£ (CBinary, TString, CGroup) è°ƒç”¨è§„èŒƒä¸é€ŸæŸ¥è¡¨
globs: HD_*/**/*.{cpp,h}, diagnostic_rules/**/*
alwaysApply: true
---

# ğŸ› ï¸ å¹³å°æ¥å£è°ƒç”¨æŒ‡å— (Platform Interface Constraints)

**ç›®æ ‡**ï¼šæ­£ç¡®ä½¿ç”¨ `platform` æä¾›çš„åŸºç¡€è®¾æ–½ç±»ï¼Œé¿å…å†…å­˜æ³„æ¼ã€ç¬¦å·å†²çªä¸ API è¯¯ç”¨ã€‚

## ğŸš¨ æ¥å£è‡ªæ£€æ¸…å• (Interface Checklist)

åœ¨è°ƒç”¨ä»»ä½•å¹³å°æ¥å£å‰ï¼Œ**MUST** æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ] **æ‰€æœ‰æƒæ£€æŸ¥**ï¼šè¿”å› `T*` (è£¸æŒ‡é’ˆ) çš„æ¥å£ï¼Œ**ä¸¥ç¦ delete**ï¼›è¿”å› `unique_ptr` å¿…é¡»æ¥ç®¡ã€‚
- [ ] **å…¨å±€å˜é‡**ï¼šä»…ä½¿ç”¨ `extern` å£°æ˜çš„å…¨å±€å¯¹è±¡ï¼Œ**ä¸¥ç¦**åœ¨ä¸šåŠ¡ä»£ç ä¸­é‡å®šä¹‰ (ODR Violation)ã€‚
- [ ] **API æ‹¼å†™**ï¼šç¡®è®¤ä½¿ç”¨çš„æ˜¯ `Add()` (PascalCase) è€Œé `push_back()`ï¼Œ`GetSize()` è€Œé `size()`ã€‚
- [ ] **è¿”å›å€¼**ï¼šå¿…é¡»æ£€æŸ¥ `Result` æˆ– `BOOL` è¿”å›å€¼ï¼Œ**ä¸¥ç¦**å¿½ç•¥é”™è¯¯çŠ¶æ€ã€‚

## ğŸ“š æ ¸å¿ƒç±»é€ŸæŸ¥è¡¨ (Core Classes Cheatsheet)

### Header: `platform/inc/binary.h`

#### 1. `CBinary` (Byte Array)
ç”¨äºå­˜å‚¨ UDS åŸå§‹å­—èŠ‚æµã€‚

| æ“ä½œ | å¹³å° API | å¯¹åº” STL (ä»…ä½œç†è§£) | æ³¨æ„äº‹é¡¹ |
| :--- | :--- | :--- | :--- |
| **æ„é€ ** | `CBinary(const char* p, WORD len)` | `vector<uint8_t>(p, p+len)` | å¿…é¡»ä¼ é•¿åº¦ |
| **è¿½åŠ ** | `Append(const char* p, WORD len)` | `insert(end, p, p+len)` | |
| **è·å–** | `BYTE GetAt(WORD index)` | `at(index)` | |
| **å¤§å°** | `WORD GetSize()` | `size()` | è¿”å›ç±»å‹æ˜¯ `WORD` |
| **æŒ‡é’ˆ** | `BYTE* GetBuffer()` | `data()` | |

**âœ… DO:**
```cpp
const char raw[] = "\x10\x01";
CBinary payload(raw, 2); // å¿…é¡»æŒ‡å®šé•¿åº¦
payload.Append("\x00", 1);
BYTE sid = payload.GetAt(0);
```

**âŒ DON'T:**
```cpp
CBinary data;
data.push_back(0x10); // âŒ ç¼–è¯‘é”™è¯¯ï¼šæ²¡æœ‰ push_backï¼Œè¯·ç”¨ Append
data.size();          // âŒ ç¼–è¯‘é”™è¯¯ï¼šæ²¡æœ‰ sizeï¼Œè¯·ç”¨ GetSize
```

#### 2. `TString` (String Wrapper)
ç”¨äºæ—§ç‰ˆæ¥å£ä¼ å‚ï¼Œæ–°ä»£ç é€»è¾‘æ¨èç”¨ `std::string`ã€‚

| æ“ä½œ | å¹³å° API | å¯¹åº” STL (ä»…ä½œç†è§£) | æ³¨æ„äº‹é¡¹ |
| :--- | :--- | :--- | :--- |
| **è·å– Cä¸²** | `const char* AsString()` | `c_str()` | æ–¹æ³•åæ˜¯ `AsString` |
| **é•¿åº¦** | `WORD GetLength()` | `length()` | |
| **è¿½åŠ ** | `Append(const char* str)` | `append()` | |
| **åˆ¤ç©º** | `BOOL IsEmpty()` | `empty()` | |

**âœ… DO:**
```cpp
TString ts("Hello");
// ä»…åœ¨ä¼ ç»™æ—§æ¥å£æ—¶ä½¿ç”¨
LegacyFunction(ts.AsString());
```

**âŒ DON'T:**
```cpp
TString ts;
ts.length(); // âŒ ç¼–è¯‘é”™è¯¯ï¼šè¯·ç”¨ GetLength()
std::string s = ts; // âŒ éšå¼è½¬æ¢å¯èƒ½å¤±è´¥ï¼Œè¯·æ˜¾å¼æ„é€ 
```

#### 3. `CGroup<T>` (Vector Wrapper)
ç”¨äºæ—§ç‰ˆåˆ—è¡¨å®¹å™¨ã€‚

| æ“ä½œ | å¹³å° API | å¯¹åº” STL (ä»…ä½œç†è§£) | æ³¨æ„äº‹é¡¹ |
| :--- | :--- | :--- | :--- |
| **æ·»åŠ ** | `Add(T item)` | `push_back(item)` | æ–¹æ³•åæ˜¯ `Add` |
| **è·å–** | `T GetAt(WORD index)` | `at(index)` | |
| **å¤§å°** | `WORD GetSize()` | `size()` | |
| **æ¸…ç©º** | `Empty()` | `clear()` | |

**âœ… DO:**
```cpp
CGroup<int> list;
list.Add(42);
int val = list.GetAt(0);
```

**âŒ DON'T:**
```cpp
CGroup<int> list;
list[0]; // âŒ ä¸æ”¯æŒä¸‹æ ‡æ“ä½œç¬¦ï¼Œè¯·ç”¨ GetAt(0)
```

### Header: `platform/inc/platform_globals.h` (General Resources)

#### 1. å…¨å±€å¯¹è±¡ä¸èµ„æºç®¡ç†
ç®¡ç†å•ä¾‹è®¿é—®ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚

**âœ… DO:**
```cpp
// 1. æ­£ç¡®ä½¿ç”¨å…¨å±€å¯¹è±¡
// platform_globals.h: extern ILogger* g_logger;
if (g_logger) {
    g_logger->Log("Starting session...");
}

// 2. èµ„æºç”Ÿå‘½å‘¨æœŸ
auto session = factory->CreateSession(); // å‡è®¾è¿”å› unique_ptr
session->Start(); // è‡ªåŠ¨ææ„ï¼Œæ— éœ€ delete
```

**âŒ DON'T:**
```cpp
// 1. é‡å®šä¹‰å…¨å±€å˜é‡
ILogger* g_logger = nullptr; // âŒ é“¾æ¥é”™è¯¯ï¼šä¸ platform å†²çª (ODR Violation)

// 2. é”™è¯¯é‡Šæ”¾æ‰€æœ‰æƒ
auto* dev = devMgr->GetActiveDevice(); // è¿”å›è§‚å¯Ÿè€…è£¸æŒ‡é’ˆ
delete dev; // âŒ ä¸¥é‡é”™è¯¯ï¼šä½ æ²¡æœ‰æ‰€æœ‰æƒï¼Œä¼šå¯¼è‡´ Crash
```
