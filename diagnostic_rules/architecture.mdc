---
description: è¯Šæ–­ä¸šåŠ¡çš„åˆ†å±‚æ¶æ„ä¸è®¾è®¡çº¦æŸ (Architecture & Layering)
globs: HD_*/**/*, diagnostic_rules/**/*
alwaysApply: true
---

# ğŸ—ï¸ è¯Šæ–­æ¶æ„çº¦æŸ (Architecture & Layering)

**ç›®æ ‡**ï¼šç¡®ä¿ `HD_<Carline>` ä¸šåŠ¡é€»è¾‘é«˜å†…èšã€ä½è€¦åˆï¼Œä¸¥æ ¼éµå®ˆåˆ†å±‚ä¸ä¾èµ–åŸåˆ™ã€‚

## ğŸš¨ æ¶æ„è‡ªæ£€æ¸…å• (Architecture Checklist)

åœ¨è®¾è®¡æˆ–ä¿®æ”¹ä»£ç ç»“æ„æ—¶ï¼Œ**MUST** æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ] **ç‰©ç†ç›®å½•æ£€æŸ¥**ï¼šç¡®è®¤ä»£ç ä½äº `HD_<Carline>/code`ï¼Œæ•°æ®ä½äº `HD_<Carline>/data`ã€‚
- [ ] **ä¾èµ–æ–¹å‘æ£€æŸ¥**ï¼šç¡®è®¤ä¾èµ–æ–¹å‘ä¸º `app -> domain -> infrastructure / data_access`ï¼Œç¦æ­¢åå‘æˆ–è·¨å±‚è°ƒç”¨ã€‚
- [ ] **å¹³å°éš”ç¦»æ£€æŸ¥**ï¼šç¡®è®¤ `domain` å±‚ä»£ç **æœªåŒ…å«** `platform/inc` å¤´æ–‡ä»¶ã€‚
- [ ] **RP1210 éš”ç¦»**ï¼šç¡®è®¤æ‰€æœ‰ RP1210 åŠ¨æ€åŠ è½½é€»è¾‘å°è£…åœ¨ `infrastructure` å±‚å•ç‹¬æ–‡ä»¶ä¸­ã€‚
- [ ] **æ•°æ®é©±åŠ¨**ï¼šç¡®è®¤è½¦å‹å·®å¼‚å‚æ•°ï¼ˆå¦‚ CAN IDã€è¶…æ—¶ï¼‰é€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½ï¼Œè€Œéç¡¬ç¼–ç ã€‚

## ğŸ“‚ é€»è¾‘åˆ†å±‚å®šä¹‰ (Logical Layers)

| å±‚çº§ (Layer) | ç›®å½• | èŒè´£ (Responsibility) | ä¾èµ–çº¦æŸ (Dependencies) |
| :--- | :--- | :--- | :--- |
| **App** | `code/app` | ç”¨ä¾‹ç¼–æ’ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€UI é€‚é… | âœ… `domain`, `infra`, `data` <br> âŒ `platform` (ç›´æ¥) |
| **Domain** | `code/domain` | **æ ¸å¿ƒä¸šåŠ¡**ï¼šçŠ¶æ€æœºã€åè®®é€»è¾‘ã€å®ä½“æ¨¡å‹ | âœ… `data` (Interfaces) <br> âŒ `platform`, `infra` (å…·ä½“å®ç°) |
| **Infrastructure** | `code/infrastructure` | **é€‚é…å±‚**ï¼šé€šä¿¡ã€æ—¥å¿—ã€å®šæ—¶å™¨ã€RP1210 åŠ è½½ | âœ… `platform/inc`, OS API |
| **Data Access** | `code/data_access` | **æ•°æ®å±‚**ï¼šè¯»å†™ `data/` ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ | âœ… `platform` (File IO) |

## âœ… DO (æœ€ä½³å®è·µ)

```cpp
// 1. é¢†åŸŸå±‚å®šä¹‰æŠ½è±¡æ¥å£ (Domain Interface)
// file: code/domain/interfaces/itransport.h
class IDiagTransport {
public:
    virtual Result<void> Send(const std::vector<uint8_t>& data) = 0;
};

// 2. åŸºç¡€è®¾æ–½å±‚å®ç°æ¥å£ (Infrastructure Implementation)
// file: code/infrastructure/can_transport.h
#include "platform/inc/can_driver.h" // ä»…åœ¨æ­¤å±‚å¼•å…¥å¹³å°å¤´æ–‡ä»¶
class CanTransport : public IDiagTransport {
    // è°ƒç”¨å¹³å° API å®ç°å‘é€
};

// 3. åº”ç”¨å±‚æ³¨å…¥ä¾èµ– (App Injection)
// file: code/app/diag_session.cpp
void StartSession() {
    auto transport = std::make_shared<CanTransport>();
    auto service = std::make_shared<UdsService>(transport); // æ³¨å…¥æŠ½è±¡
    service->Start();
}
```

## âŒ DON'T (å¸¸è§é”™è¯¯)

```cpp
// 1. é¢†åŸŸå±‚ç›´æ¥ä¾èµ–å¹³å° (Domain Violation)
// file: code/domain/uds_service.cpp
#include "platform/inc/can_driver.h" // âŒ ç¦æ­¢ï¼é¢†åŸŸå±‚ä¸å¾—æ±¡æŸ“å¹³å°ç»†èŠ‚

void UdsService::Send() {
    PlatformCanDriver::Write(...); // âŒ é”™è¯¯ï¼šç›´æ¥è°ƒç”¨é™æ€æ–¹æ³•
}

// 2. è·¨å±‚è°ƒç”¨ (Layer Skipping)
// file: code/app/main.cpp
#include <windows.h>
void LoadDriver() {
    LoadLibrary("rp1210.dll"); // âŒ é”™è¯¯ï¼šApp å±‚ç¦æ­¢ç›´æ¥æ“ä½œ OS APIï¼Œåº”ä¸‹æ²‰è‡³ Infra å±‚
}
```

## ğŸ”Œ RP1210 åŠ¨æ€åŠ è½½è§„èŒƒ

- **å°è£…**ï¼šå¿…é¡»åœ¨ `infrastructure/rp1210_loader.{h,cpp}` ä¸­å®ç°ã€‚
- **åŠ è½½**ï¼šä½¿ç”¨ `LoadLibrary` / `GetProcAddress`ã€‚
- **å®‰å…¨**ï¼šå¿…é¡»æ£€æŸ¥ DLL æ˜¯å¦å­˜åœ¨åŠå‡½æ•°æŒ‡é’ˆæ˜¯å¦æœ‰æ•ˆï¼Œ**ä¸¥ç¦ Crash**ã€‚
- **æ¥å£**ï¼šå¯¹å¤–æš´éœ² `IRp1210Device` æŠ½è±¡æ¥å£ï¼Œå±è”½ `short` / `long` ç­‰åº•å±‚ç±»å‹å·®å¼‚ã€‚

## ğŸ§¬ æ‰©å±•æ€§è®¾è®¡ (Extensibility)

- **è½¦ç³»æ‰©å±•**ï¼šé€šè¿‡æ–°å¢ `HD_<Carline>` ç›®å½•éš”ç¦»ã€‚
- **è½¦å‹å·®å¼‚**ï¼šé€šè¿‡ `data/*.json` æˆ– `data/*.ini` é…ç½®é©±åŠ¨ï¼Œç¦æ­¢å¤§é‡ `if (model == X)`ã€‚
- **åŠŸèƒ½å¼€å…³**ï¼šä½¿ç”¨ç­–ç•¥æ¨¡å¼ (Strategy Pattern) æˆ– å·¥å‚æ¨¡å¼ (Factory) åŠ¨æ€åˆ›å»ºä¸šåŠ¡å¯¹è±¡ã€‚
